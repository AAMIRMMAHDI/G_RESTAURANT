<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رستوران مدرن - سفارش آنلاین</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B6B; --primary-dark: #EE5A52; --secondary: #4ECDC4;
            --dark: #292F36; --light: #F7F7F7; --gray: #8A8A8A; --gold: #FFD166;
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --shadow: 0 10px 30px rgba(0,0,0,0.08); --radius: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazirmatn', sans-serif; }
        body { background: var(--light); color: var(--dark); overflow-x: hidden; }
        header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); position: fixed; top: 0; width: 100%; z-index: 1000; padding: 1rem 0; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .header-container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 800; font-size: 1.8rem; color: var(--dark); }
        .logo-icon { color: var(--primary); background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .cart-icon { position: relative; background: var(--light); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--shadow); transition: var(--transition); }
        .cart-icon:hover { transform: translateY(-3px); }
        .cart-count { position: absolute; top: -5px; left: -5px; background: var(--primary); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; }

        .hero { min-height: 100vh; display: flex; align-items: center; background: linear-gradient(135deg, rgba(41,47,54,0.9), rgba(41,47,54,0.7)), url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=1950&q=80'); background-size: cover; background-position: center; color: white; padding: 0 2rem; }
        .hero-content { max-width: 1400px; margin: 0 auto; width: 100%; }
        .hero-title { font-size: 4rem; font-weight: 800; background: linear-gradient(to right, #fff, var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1.5rem; }
        .hero-subtitle { font-size: 1.3rem; margin-bottom: 2.5rem; opacity: 0.9; max-width: 600px; }
        .btn { padding: 1rem 2.5rem; border-radius: 50px; font-weight: 600; cursor: pointer; transition: var(--transition); border: none; display: inline-flex; align-items: center; gap: 10px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 10px 25px rgba(255,107,107,0.4); }
        .btn-primary:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(255,107,107,0.5); }

        .menu-section { padding: 6rem 2rem; max-width: 1400px; margin: 0 auto; }
        .section-title { font-size: 2.8rem; font-weight: 800; text-align: center; margin-bottom: 1rem; position: relative; }
        .section-title:after { content: ''; position: absolute; bottom: -10px; right: 50%; transform: translateX(50%); width: 80px; height: 4px; background: linear-gradient(to right, var(--primary), var(--secondary)); border-radius: 2px; }
        .categories { display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; margin: 3rem 0; }
        .category-btn { padding: 0.8rem 1.8rem; border-radius: 50px; background: white; border: 1px solid #eee; color: var(--dark); font-weight: 500; cursor: pointer; transition: var(--transition); box-shadow: var(--shadow); }
        .category-btn.active, .category-btn:hover { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; transform: translateY(-3px); }

        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 2rem; }
        .menu-card { background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transition: var(--transition); }
        .menu-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.12); }
        .card-image { height: 220px; background-size: cover; background-position: center; position: relative; }
        .card-overlay { position: absolute; bottom: 0; right: 0; width: 100%; height: 50%; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); display: flex; align-items: flex-end; padding: 1.5rem; color: white; }
        .card-price { font-size: 1.5rem; font-weight: 700; }
        .card-content { padding: 1.5rem; }
        .card-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 0.5rem; }
        .card-description { color: var(--gray); margin-bottom: 1.5rem; line-height: 1.6; }
        .card-actions { display: flex; justify-content: space-between; align-items: center; }
        .quantity-selector { display: flex; align-items: center; background: var(--light); border-radius: 50px; overflow: hidden; }
        .qty-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: white; border: none; cursor: pointer; transition: var(--transition); font-size: 1.2rem; }
        .qty-btn:hover { background: #f0f0f0; }
        .qty-value { padding: 0 1rem; font-weight: 600; min-width: 30px; text-align: center; }
        .add-to-cart { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 50px; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px; }
        .add-to-cart:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255,107,107,0.3); }

        .cart-sidebar { position: fixed; top: 0; left: -450px; width: 420px; height: 100vh; background: white; box-shadow: -5px 0 30px rgba(0,0,0,0.1); z-index: 2000; transition: var(--transition); display: flex; flex-direction: column; }
        .cart-sidebar.open { left: 0; }
        .cart-header { padding: 1.5rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .cart-title { font-size: 1.5rem; font-weight: 700; }
        .close-cart { background: var(--light); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        .cart-items { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .cart-item { display: flex; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid #eee; }
        .cart-item-image { width: 80px; height: 80px; border-radius: 12px; background-size: cover; background-position: center; flex-shrink: 0; }
        .cart-item-name { font-weight: 600; margin-bottom: 0.5rem; }
        .cart-item-price { color: var(--primary); font-weight: 700; margin-bottom: 0.5rem; }
        .remove-item { background: none; border: none; color: var(--gray); cursor: pointer; }
        .remove-item:hover { color: var(--primary); }
        .cart-footer { padding: 1.5rem; border-top: 1px solid #eee; }
        .cart-total { display: flex; justify-content: space-between; font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; }
        .checkout-btn { background: linear-gradient(135deg, var(--secondary), #3bbcb4); color: white; border: none; width: 100%; padding: 1.2rem; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .checkout-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(78,205,196,0.3); }

        .order-section { padding: 6rem 2rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef); display: none; }
        .order-container { max-width: 1000px; margin: 0 auto; background: white; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
        .order-header { background: linear-gradient(135deg, var(--dark), #3a424d); color: white; padding: 2rem; text-align: center; }
        .order-title { font-size: 2.2rem; font-weight: 700; }
        .order-form { padding: 2.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-control { width: 100%; padding: 1rem 1.2rem; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 1rem; transition: var(--transition); }
        .form-control:focus { border-color: var(--secondary); outline: none; box-shadow: 0 0 0 3px rgba(78,205,196,0.2); }
        .submit-order { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; width: 100%; padding: 1.2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 1rem; }
        .submit-order:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255,107,107,0.3); }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1500; display: none; }
        .overlay.active { display: block; }

        @media (max-width: 768px) {
            .hero-title { font-size: 2.5rem; }
            .menu-grid { grid-template-columns: 1fr; }
            .cart-sidebar { width: 100%; left: -100%; }
        }
    </style>
</head>
<body>

    <!-- هدر -->
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-utensils logo-icon"></i>
                <span>فود‌کورت</span>
            </div>
            <div class="cart-icon" id="cartToggle">
                <i class="fas fa-shopping-bag"></i>
                <div class="cart-count" id="cartCount">0</div>
            </div>
        </div>
    </header>

    <!-- هیرو -->
    <section class="hero">
        <div class="hero-content">
            <div class="hero-text">
                <h1 class="hero-title">تجربه طعم‌های بی‌نظیر</h1>
                <p class="hero-subtitle">در رستوران ما، هر وعده غذایی یک سفر حسّی است. از غذاهای محلی تا بین‌المللی، با بهترین مواد اولیه.</p>
                <button type="button" class="btn btn-primary" id="viewMenuBtn">
                    <i class="fas fa-utensils"></i>
                    مشاهده منو
                </button>
            </div>
        </div>
    </section>

    <!-- منو -->
    <section class="menu-section" id="menu">
        <h2 class="section-title">منوی رستوران</h2>
        <div class="categories">
            <button type="button" class="category-btn active" data-category="all">همه</button>
            {% for cat in categories %}
            <button type="button" class="category-btn" data-category="{{ cat.id }}">{{ cat.name }}</button>
            {% endfor %}
        </div>

        <div class="menu-grid" id="menuGrid">
            {% for item in menu_items %}
            <div class="menu-card" data-category="{{ item.category.id }}">
                <div class="card-image" style="background-image: url('{% if item.image %}{{ item.image.url }}{% else %}/static/no-image.jpg{% endif %}')">
                    <div class="card-overlay">
                        <div class="card-price">{{ item.price }} تومان</div>
                    </div>
                </div>
                <div class="card-content">
                    <h3 class="card-title">{{ item.name }}</h3>
                    <p class="card-description">{{ item.description|default:"—" }}</p>
                    <div class="card-actions">
                        <div class="quantity-selector">
                            <button type="button" class="qty-btn minus" data-id="{{ item.id }}">-</button>
                            <span class="qty-value" id="qty-{{ item.id }}">0</span>
                            <button type="button" class="qty-btn plus" data-id="{{ item.id }}">+</button>
                        </div>
                        <button type="button" class="add-to-cart" data-id="{{ item.id }}">
                            <i class="fas fa-cart-plus"></i> افزودن
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- سایدبار سبد خرید -->
    <div class="overlay" id="overlay"></div>
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3 class="cart-title">سبد خرید</h3>
            <button type="button" class="close-cart" id="closeCart"><i class="fas fa-times"></i></button>
        </div>
        <div class="cart-items" id="cartItems">
            <p style="text-align:center;color:#999;margin:2rem;">سبد خالی است</p>
        </div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>مجموع:</span>
                <span id="sidebarTotal">0 تومان</span>
            </div>
            <button type="button" class="checkout-btn" id="checkoutBtn">
                <i class="fas fa-paper-plane"></i> ثبت سفارش
            </button>
        </div>
    </div>

    <!-- فرم سفارش -->
    <section class="order-section" id="orderFormSection">
        <div class="order-container">
            <div class="order-header">
                <h2 class="order-title">ثبت سفارش نهایی</h2>
            </div>
            <form method="post" action="{% url 'index:place_order' %}" class="order-form">
                {% csrf_token %}
                <div class="form-group">
                    <label class="form-label">شماره میز</label>
                    {{ form.table_number }}
                </div>
                <div class="form-group">
                    <label class="form-label">درخواست ویژه (اختیاری)</label>
                    {{ form.special_requests }}
                </div>
                <button type="submit" class="submit-order">
                    <i class="fas fa-check-circle"></i> تأیید و ارسال سفارش
                </button>
            </form>
        </div>
    </section>

    <script>
        // داده‌های منو از Django
        const menuItems = {{ menu_items_json|safe }};

        // سبد خرید: اول از sessionStorage، بعد از session سرور
        let cart = JSON.parse(sessionStorage.getItem('django_cart') || '[]');

        // اگر سرور سبدی داره، جایگزین کن (برای وقتی که کاربر قبلاً سفارش داده)
        {% if request.session.cart %}
            cart = {{ request.session.cart|safe }};
            sessionStorage.setItem('django_cart', JSON.stringify(cart));
        {% endif %}

        const csrfToken = '{{ csrf_token }}';
        const syncCartUrl = '{% url "index:sync_cart" %}';

        // المنت‌ها
        const cartCountEl = document.getElementById('cartCount');
        const cartItemsEl = document.getElementById('cartItems');
        const sidebarTotalEl = document.getElementById('sidebarTotal');

        // همگام‌سازی با سرور
        function syncCartToServer() {
            fetch(syncCartUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ cart: cart })
            });
        }

        // به‌روزرسانی تعداد
        function updateCartCount() {
            const total = cart.reduce((sum, i) => sum + i.quantity, 0);
            cartCountEl.textContent = total;
        }

        // ذخیره سبد (مرورگر + سرور)
        function saveCart() {
            sessionStorage.setItem('django_cart', JSON.stringify(cart));
            updateCartCount();
            renderCart();
            syncCartToServer(); // مهم!
        }

        // افزودن به سبد
        function addToCart(id) {
            const qtyEl = document.getElementById(`qty-${id}`);
            const qty = parseInt(qtyEl.textContent) || 0;
            if (qty === 0) return;

            const item = menuItems.find(i => i.id === id);
            const existing = cart.find(c => c.id === id);

            if (existing) {
                existing.quantity += qty;
            } else {
                cart.push({ id: item.id, name: item.name, price: item.price, quantity: qty, image: item.image });
            }

            qtyEl.textContent = '0';
            saveCart();
            openCartSidebar();
        }

        // رندر سبد
        function renderCart() {
            if (cart.length === 0) {
                cartItemsEl.innerHTML = '<p style="text-align:center;color:#999;margin:2rem;">سبد خالی است</p>';
                sidebarTotalEl.textContent = '0 تومان';
                return;
            }

            let total = 0;
            cartItemsEl.innerHTML = '';
            cart.forEach(item => {
                total += item.price * item.quantity;
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div class="cart-item-image" style="background-image:url('${item.image || '/static/no-image.jpg'}')"></div>
                    <div style="flex:1">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${(item.price * item.quantity).toLocaleString()} تومان</div>
                        <div style="display:flex;gap:0.5rem;align-items:center;margin-top:0.5rem;">
                            <button type="button" class="qty-btn minus" onclick="changeQty(${item.id}, -1)">-</button>
                            <span class="qty-value">${item.quantity}</span>
                            <button type="button" class="qty-btn plus" onclick="changeQty(${item.id}, 1)">+</button>
                            <button type="button" class="remove-item" onclick="removeFromCart(${item.id})">حذف</button>
                        </div>
                    </div>
                `;
                cartItemsEl.appendChild(div);
            });
            sidebarTotalEl.textContent = total.toLocaleString() + ' تومان';
        }

        // تغییر تعداد
        window.changeQty = function(id, delta) {
            const item = cart.find(i => i.id === id);
            if (!item) return;
            item.quantity = Math.max(1, item.quantity + delta);
            if (item.quantity === 0) removeFromCart(id);
            else saveCart();
        };

        window.removeFromCart = function(id) {
            cart = cart.filter(i => i.id !== id);
            saveCart();
        };

        // باز/بستن سایدبار
        function openCartSidebar() {
            document.getElementById('cartSidebar').classList.add('open');
            document.getElementById('overlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        document.getElementById('cartToggle').addEventListener('click', openCartSidebar);
        document.getElementById('closeCart').addEventListener('click', () => {
            document.getElementById('cartSidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        });
        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('closeCart').click();
        });

        // ثبت سفارش نهایی
        document.getElementById('checkoutBtn').addEventListener('click', () => {
            if (cart.length === 0) {
                alert('سبد خرید خالی است!');
                return;
            }

            // آخرین بار sync کن
            fetch(syncCartUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ cart: cart })
            }).then(() => {
                document.getElementById('closeCart').click();
                document.getElementById('orderFormSection').style.display = 'block';
                document.getElementById('orderFormSection').scrollIntoView({ behavior: 'smooth' });
            });
        });

        // دکمه‌های + / -
        document.querySelectorAll('.qty-btn.plus, .qty-btn.minus').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.dataset.id);
                const el = document.getElementById(`qty-${id}`);
                let val = parseInt(el.textContent) || 0;
                if (btn.classList.contains('plus')) val++;
                else if (val > 0) val--;
                el.textContent = val;
            });
        });

        // افزودن به سبد
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', () => {
                addToCart(parseInt(btn.dataset.id));
            });
        });

        // فیلتر دسته‌بندی
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const cat = btn.dataset.category;
                document.querySelectorAll('.menu-card').forEach(card => {
                    card.style.display = (cat === 'all' || card.dataset.category == cat) ? 'block' : 'none';
                });
            });
        });

        // اسکرول به منو
        document.getElementById('viewMenuBtn').addEventListener('click', () => {
            document.getElementById('menu').scrollIntoView({ behavior: 'smooth' });
        });

        // راه‌اندازی اولیه
        updateCartCount();
        renderCart();
    </script>
</body>
</html>